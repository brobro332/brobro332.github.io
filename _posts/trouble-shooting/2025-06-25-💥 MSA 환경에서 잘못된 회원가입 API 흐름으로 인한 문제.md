---
title: 💥 MSA 환경에서 잘못된 회원가입 API 흐름으로 인한 문제
date: 2025-06-25 20:11:00 +0900
categories:
  - Trouble-Shooting
tags:
  - Trouble-Shooting
  - Spring-Cloud-Gateway
---

### 문제 상황
- 각 서비스의 계정을 통합 관리하기 위해 중앙에 `Gateway` 통합 인증 서버를 둠.
- 각 서비스에서 사용자 메타 데이터를 저장하고 중앙 데이터와 매핑하려면 회원가입 시 생성된 `UUID`가 필요함.
- 현재 구조에서는 각 서비스가 역으로 `Gateway API`를 호출해 `UUID`를 받아오는 방식임.
- 이로 인해 각 서비스가 `Gateway` 서버에 의존하게 됨.
- `CORS` 이슈 및 `Spring Security` 필터 충돌로 인해 `API` 호출이 복잡해져 유지 보수 및 보안 설정이 점점 어려워짐.


### 문제 원인

- 비즈니스 로직 상 `Gateway` 서버가 중심 역할을 해야 함에도 불구하고 각 서비스가 사용자 등록을 위해 별도로 `Gateway` 서버에서 `UUID`를 가져가야 하는 구조는 역방향 흐름이고, `SRP` 위반임.


### 해결 방법
- 회원가입 흐름을 정방향으로 재설계

1. 클라이언트가 `Gateway` 서버에 회원가입을 요청함.
2. `Gateway` 서버가 회원가입을 처리하고, 생성한 `UUID`와 함께 서비스별 사용자 메타 데이터를 각 서비스에 전달함.
3. 각 서비스는 전달받은 `UUID` 및 메타 데이터로 사용자 정보를 저장함.


### 개선 효과

- `Gateway` 서버가 회원가입 흐름을 통제, 서비스는 메타 데이터 저장만 담당하여 `Gateway` 서버 중심의 책임 분리
- 서비스 → `Gateway` 서버 호출 제거로 `CORS` 및 필터 설정 단순화 
- 흐름이 직관적이며, 각 계층의 역할을 명확하여 유지 보수 용이성 향상


### 회고
- 참고로 기존 로직은 다음과 같다.

1. [클라이언트] `Gateway` 서버로 특정 서비스에 회원가입 요청
2. [`Gateway`] 받은 요청을 특정 서비스로 프록싱
3. [특정 서비스] `Gateway` 서버로 회원가입 요청
4. [`Gateway`] 회원가입 처리 및 매핑을 위한 계정 `UUID` 응답
5. [특정 서비스] 응답 받은 UUID와 함께 서비스별 사용자 메타 데이터를 함께 저장

- 모든 요청을 `Gateway` 서버로 받아서 각 서비스에 프록싱하는 구조로 설계를 하였는데, `Spring Security` 및 `JWT`를 통한 인증 및 인가 기능도 `Gateway` 서버에서 담당하다 보니 이러한 복잡한 로직이 되어 버렸다.
- 로직이 복잡하더라도 각 서비스의 비즈니스 로직의 출발점은 해당 서비스에 있다고 생각해서 일관성을 위해 강행했었다.
- 하지만 로직의 복잡성은 유지 보수를 어렵게 하였고, `MSA` 아키텍처를 고려해서 서비스와 `Gateway` 서버의 `Docker-compose` 파일이 분리되어 있어서, 문제가 발생한다고 하면 어디가 문제인지 진단하기가 더욱 어려웠다.
- 문제 해결에 있어 일관성도 중요하지만, 유연함 역시 필수임을 실감했다.